<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NutriScan</title>

<script src="https://cdn.tailwindcss.com?plugins=forms"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: "#4caeaa",
        "background-light": "#f6f7f7",
      },
      fontFamily: {
        display: ["Inter"]
      }
    }
  }
}
</script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: 'Inter', sans-serif; }
</style>
</head>

<body class="bg-background-light overflow-x-hidden">

<!-- SPLASH SCREEN -->
<div id="splash" class="fixed inset-0 bg-primary flex items-center justify-center z-50 transition-opacity duration-1000">
  <h1 class="text-white text-5xl font-black tracking-widest">NUTRISCAN</h1>
</div>

<!-- MAIN APP -->
<div id="app" class="hidden relative">

<!-- REFINED BACKGROUND STICKERS -->
<div class="absolute inset-0 pointer-events-none overflow-hidden">

  <span class="absolute top-10 left-10 text-primary text-8xl opacity-10">ü•¶</span>
  <span class="absolute top-20 right-16 text-primary text-7xl opacity-10">üçé</span>
  <span class="absolute top-1/3 left-20 text-primary text-9xl opacity-10">ü•ï</span>
  <span class="absolute top-1/2 right-24 text-primary text-8xl opacity-10">ü•ë</span>
  <span class="absolute bottom-24 left-32 text-primary text-7xl opacity-10">ü•¨</span>
  <span class="absolute bottom-16 right-10 text-primary text-9xl opacity-10">üçä</span>

  <span class="absolute top-1/4 left-1/3 text-primary text-[12rem] opacity-[0.04]">
    ü•ó
  </span>

</div>

<header class="bg-white border-b border-[#eaf0f0] px-6 md:px-40 py-3 flex justify-between">
  <h2 class="text-xl font-bold">NutriScan</h2>
  <span class="material-symbols-outlined text-primary">person</span>
</header>

<main class="flex justify-center py-8 px-4">
<div class="max-w-[720px] w-full relative">

<!-- PROGRESS BAR -->
<div class="mb-6">
  <div class="flex justify-between mb-2">
    <p class="font-semibold">Scan Progress</p>
    <p id="progress-text" class="text-primary font-bold">0%</p>
  </div>
  <div class="rounded-full bg-[#d6e1e1] h-3">
    <div id="progress-bar" class="h-full bg-primary rounded-full w-0 transition-all duration-500"></div>
  </div>
</div>

<!-- ACTION SECTIONS -->
<div class="space-y-4">

  <!-- SCAN CAMERA -->
  <button onclick="startScanner()" 
    class="w-full bg-white border border-[#eaf0f0] rounded-xl p-6 shadow-sm hover:shadow-md transition flex items-center gap-4">
    <span class="material-symbols-outlined text-primary text-3xl">qr_code_scanner</span>
    <div>
      <p class="font-bold">Scan Barcode</p>
      <p class="text-sm text-[#608584]">Use camera to scan product</p>
    </div>
  </button>

  <!-- ENTER BARCODE -->
  <div class="bg-white border border-[#eaf0f0] rounded-xl p-6 shadow-sm">
    <div class="flex items-center gap-4 mb-3">
      <span class="material-symbols-outlined text-primary text-3xl">dialpad</span>
      <p class="font-bold">Enter Barcode</p>
    </div>
    <div class="flex gap-2">
      <input id="barcode-input" type="text" placeholder="Enter barcode number"
        class="flex-1 rounded-lg border-[#d6e1e1] focus:ring-primary focus:border-primary">
      <button onclick="searchByBarcode()" class="bg-primary text-white px-4 rounded-lg">
        Search
      </button>
    </div>
  </div>

  <!-- SEARCH PRODUCT NAME -->
  <div class="bg-white border border-[#eaf0f0] rounded-xl p-6 shadow-sm">
    <div class="flex items-center gap-4 mb-3">
      <span class="material-symbols-outlined text-primary text-3xl">search</span>
      <p class="font-bold">Search by Product Name</p>
    </div>
    <div class="flex gap-2">
      <input id="product-input" type="text" placeholder="Enter product name"
        class="flex-1 rounded-lg border-[#d6e1e1] focus:ring-primary focus:border-primary">
      <button onclick="searchByName()" class="bg-primary text-white px-4 rounded-lg">
        Search
      </button>
    </div>
  </div>

</div>

<div id="reader" class="mt-6"></div>

<!-- PRODUCT RESULT -->
<div id="product-card" class="hidden mt-6 bg-white border border-[#eaf0f0] rounded-xl p-6 shadow-sm">
  <img id="product-image" class="w-full max-h-[250px] object-contain mb-4">
  <h2 id="product-name" class="text-2xl font-bold"></h2>
  <p id="product-type" class="text-sm text-[#608584]"></p>
  <p id="veg-status" class="font-semibold mt-1"></p>

  <div class="mt-4 rounded-full bg-[#d6e1e1] h-3">
    <div id="health-meter" class="h-full rounded-full transition-all duration-500"></div>
  </div>
  <p id="health-label" class="font-bold mt-2"></p>

  <div id="allergen-warning" class="hidden mt-4 p-4 rounded-lg bg-red-100 border border-red-400 text-red-700 font-semibold flex gap-2">
    <span class="material-symbols-outlined">warning</span>
    Contains Allergens
  </div>

  <div class="mt-4">
    <h3 class="font-bold">Allergens</h3>
    <ul id="allergens" class="list-disc pl-5 text-red-600 font-semibold"></ul>
  </div>

  <div class="mt-4">
    <h3 class="font-bold">Additives</h3>
    <ul id="additives" class="list-disc pl-5"></ul>
  </div>

</div>

</div>
</main>
</div>

<script>

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Backend URL ‚Äî leave empty when served from Flask.
   Set to "http://localhost:5000" only if running
   the frontend separately.
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const API_BASE = "";

/* Splash Screen */
setTimeout(() => {
  document.getElementById("splash").style.opacity = "0";
  setTimeout(() => {
    document.getElementById("splash").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
  }, 1000);
}, 3000);

/* Progress Animation */
function updateProgress() {
  const bar = document.getElementById("progress-bar");
  const text = document.getElementById("progress-text");
  let percent = 0;
  bar.style.width = "0%";
  text.innerText = "0%";

  const interval = setInterval(() => {
    percent += 10;
    bar.style.width = percent + "%";
    text.innerText = percent + "%";
    if (percent >= 100) clearInterval(interval);
  }, 100);
}

/* Scanner ‚Äî uses html5-qrcode to read barcode from camera */
function startScanner() {
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    barcode => {
      html5QrCode.stop();
      fetchProduct(barcode);
    }
  );
}

/* Search by Barcode ‚Äî manual entry */
function searchByBarcode() {
  const code = document.getElementById("barcode-input").value.trim();
  if (code) fetchProduct(code);
}

/* Search by Name ‚Äî calls the backend /search-product endpoint */
function searchByName() {
  const name = document.getElementById("product-input").value.trim();
  if (!name) return;

  updateProgress();

  fetch(`${API_BASE}/search-product`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name: name })
  })
    .then(res => {
      if (!res.ok) return res.json().then(err => { throw err; });
      return res.json();
    })
    .then(data => renderProduct(data))
    .catch(err => {
      alert(err.error || "Product not found");
      console.error("Search error:", err);
    });
}

/* Fetch Product by barcode ‚Äî calls the backend /scan-barcode endpoint */
function fetchProduct(barcode) {
  updateProgress();

  fetch(`${API_BASE}/scan-barcode`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ barcode: barcode })
  })
    .then(res => {
      if (!res.ok) return res.json().then(err => { throw err; });
      return res.json();
    })
    .then(data => renderProduct(data))
    .catch(err => {
      alert(err.error || "Product not found");
      console.error("Fetch error:", err);
    });
}

/* Render the product data into the UI */
function renderProduct(p) {
  document.getElementById("product-card").classList.remove("hidden");

  // Basic info
  document.getElementById("product-name").innerText = p.product_name || "Unknown";
  document.getElementById("product-type").innerText = p.categories || "";
  document.getElementById("product-image").src = p.image || "";

  // Veg / Non-Veg status
  const vegTags = p.ingredients_analysis_tags || [];
  document.getElementById("veg-status").innerText =
    vegTags.includes("en:vegetarian") ? "üü¢ Vegetarian" : "üî¥ Non-Vegetarian";

  // Health meter (nutriscore)
  const meter = document.getElementById("health-meter");
  const score = p.nutriscore_score || 0;
  const percent = Math.min(Math.abs(score) * 10, 100);
  meter.style.width = percent + "%";
  meter.className =
    `h-full rounded-full transition-all duration-500 ${score <= 0 ? "bg-green-500" : score <= 10 ? "bg-yellow-500" : "bg-red-500"}`;
  document.getElementById("health-label").innerText =
    score <= 0 ? "Healthy" : score <= 10 ? "Moderate" : "Unhealthy";

  // Allergens
  const allergens = document.getElementById("allergens");
  allergens.innerHTML = "";
  const allergenTags = p.allergens_tags || [];
  if (allergenTags.length) {
    document.getElementById("allergen-warning").classList.remove("hidden");
    allergenTags.forEach(a => {
      const li = document.createElement("li");
      li.innerText = a;
      allergens.appendChild(li);
    });
  } else {
    document.getElementById("allergen-warning").classList.add("hidden");
    allergens.innerHTML = "<li>No allergens detected</li>";
  }

  // Additives
  const additivesList = document.getElementById("additives");
  additivesList.innerHTML = "";
  const additivesArr = p.additives || [];
  if (additivesArr.length) {
    additivesArr.forEach(a => {
      const li = document.createElement("li");
      li.innerText = a;
      additivesList.appendChild(li);
    });
  } else {
    additivesList.innerHTML = "<li>No additives found</li>";
  }

  // Preservatives (new section ‚Äî appended under additives if present)
  const preservatives = p.preservatives || [];
  if (preservatives.length) {
    const heading = document.createElement("h3");
    heading.className = "font-bold mt-4";
    heading.innerText = "Preservatives";
    const ul = document.createElement("ul");
    ul.className = "list-disc pl-5 text-orange-600 font-semibold";
    preservatives.forEach(pr => {
      const li = document.createElement("li");
      li.innerText = pr;
      ul.appendChild(li);
    });
    // Insert after the additives section
    const additivesContainer = additivesList.parentElement;
    additivesContainer.after(ul);
    additivesContainer.after(heading);
  }

  // Ingredients
  const ingredients = p.ingredients || [];
  if (ingredients.length) {
    let ingredientsSection = document.getElementById("ingredients-section");
    if (!ingredientsSection) {
      ingredientsSection = document.createElement("div");
      ingredientsSection.id = "ingredients-section";
      ingredientsSection.className = "mt-4";
      document.getElementById("product-card").appendChild(ingredientsSection);
    }
    ingredientsSection.innerHTML =
      `<h3 class="font-bold">Ingredients</h3>
       <p class="text-sm text-[#608584] mt-1">${ingredients.join(", ")}</p>`;
  }
}

</script>

</body>
</html>
